<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Srabon's Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              inter: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
  </head>

  <body class="bg-gray-100 font-inter flex items-center justify-center min-h-screen p-2">
    <div
      class="w-full max-w-2xl h-[90vh] bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden"
    >
      <!-- Header -->
      <div class="bg-indigo-600 text-white py-4 px-6 text-center text-lg font-semibold">
        Srabon's Chatbot
      </div>

      <!-- Messages Area -->
      <div
        id="chat-messages"
        class="flex-1 overflow-y-auto px-4 py-6 space-y-4 bg-gray-50"
      >
        <div class="max-w-[80%] p-3 rounded-xl bg-gray-200 text-gray-800">
          Hello! I'm your AI-powered chatbot. How can I help you today?
        </div>
      </div>

      <!-- Input Area -->
      <div class="border-t border-gray-200 px-4 py-3 bg-white flex items-center">
        <textarea
          id="chat-input"
          rows="1"
          class="flex-grow resize-none border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="Type your message..."
        ></textarea>
        <button
          id="send-button"
          class="ml-2 bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition"
        >
          Send
        </button>
        <div
          id="loading-spinner"
          class="ml-2 hidden w-5 h-5 border-4 border-gray-300 border-l-indigo-600 rounded-full animate-spin"
        ></div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      const API_KEY = 'AIzaSyBHpyf7WrtCY6maOy1C1mlhudnfQjhgBd8';
      const MODEL_NAME = 'gemini-2.5-flash-preview-05-20';

      const chatMessages = document.getElementById("chat-messages");
      const chatInput = document.getElementById("chat-input");
      const sendButton = document.getElementById("send-button");
      const loadingSpinner = document.getElementById("loading-spinner");

      let chatHistory = [];

      function formatMessage(text) {
        text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

        const lines = text.split("\n");
        const formattedLines = [];
        let insideList = false;

        for (let line of lines) {
          const trimmed = line.trim();
          if (trimmed.startsWith("* ")) {
            if (!insideList) {
              formattedLines.push('<ul class="list-disc pl-6">');
              insideList = true;
            }
            formattedLines.push(`<li>${trimmed.slice(2)}</li>`);
          } else {
            if (insideList) {
              formattedLines.push("</ul>");
              insideList = false;
            }
            formattedLines.push(`<p>${line}</p>`);
          }
        }

        if (insideList) {
          formattedLines.push("</ul>");
        }

        return formattedLines.join("");
      }

      function displayMessage(text, sender = "bot") {
        const wrapper = document.createElement("div");
        wrapper.className = `max-w-[80%] p-3 rounded-xl ${
          sender === "user"
            ? "bg-indigo-100 text-indigo-900 self-end ml-auto"
            : "bg-gray-200 text-gray-800"
        }`;
        wrapper.innerHTML = formatMessage(text);
        chatMessages.appendChild(wrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function callGeminiAPI(prompt) {
        loadingSpinner.classList.remove("hidden");
        sendButton.disabled = true;

        chatHistory.push({ role: "user", parts: [{ text: prompt }] });

        const payload = { contents: chatHistory };
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          const botText =
            result?.candidates?.[0]?.content?.parts?.[0]?.text || "No response from Gemini.";
          displayMessage(botText, "bot");
          chatHistory.push({ role: "model", parts: [{ text: botText }] });
        } catch (error) {
          displayMessage("❌ Failed to connect to the chatbot.", "bot");
        }

        loadingSpinner.classList.add("hidden");
        sendButton.disabled = false;
        chatInput.focus();
      }

      sendButton.addEventListener("click", () => {
        const message = chatInput.value.trim();
        if (message) {
          displayMessage(message, "user");
          chatInput.value = "";
          callGeminiAPI(message);
        }
      });

      chatInput.addEventListener("keypress", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendButton.click();
        }
      });

      chatInput.addEventListener("input", () => {
        chatInput.style.height = "auto";
        chatInput.style.height = chatInput.scrollHeight + "px";
      });

      window.onload = () => chatInput.focus();
    </script>
  </body>
</html>
